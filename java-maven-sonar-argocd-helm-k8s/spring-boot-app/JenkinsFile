pipeline {
    agent {
        docker {
            image 'gayathrimurugaian/maven-docker-agent:v8'
            args '-v /var/run/docker.sock:/var/run/docker.sock -u root'
        }
    }

    environment {
        GIT_USER_NAME = 'mgayathri181'
        GIT_REPO_NAME = 'cicd_argocd'
        SONAR_URL = "http://15.157.69.245:9000"
        SONAR_TOKEN = credentials('sonar-token')
        DOCKER_IMAGE = "gayathrimurugaian/ultimate-cicd:${BUILD_NUMBER}"
        DOCKER_USERNAME = credentials('docker-username')
        DOCKER_PASSWORD = credentials('docker-password')
    }

    stages {
        stage('Checkout') {
            steps {
                git url: 'https://github.com/mgayathri181/cicd_argocd.git', branch: 'master'
            }
        }

        stage('Build') {
            steps {
                sh 'mvn clean install'
            }
        }

        stage('SonarQube Analysis') {
            steps {
                withSonarQubeEnv('SonarQube') {
                    sh "mvn sonar:sonar -Dsonar.projectKey=${GIT_REPO_NAME} -Dsonar.host.url=${SONAR_URL} -Dsonar.login=${SONAR_TOKEN}"
                }
            }
        }

        stage('Docker Build & Push') {
            steps {
                sh """
                    echo "[INFO] Changing permissions to ensure Docker can access build artifacts..."
                    chmod -R u+rw java-maven-sonar-argocd-helm-k8s/spring-boot-app/target || true

                    echo "[INFO] Building Docker image..."
                    docker build -t ${DOCKER_IMAGE} .

                    echo "[INFO] Logging into Docker Hub..."
                    echo "${DOCKER_PASSWORD}" | docker login -u "${DOCKER_USERNAME}" --password-stdin

                    echo "[INFO] Pushing image to Docker Hub..."
                    docker push ${DOCKER_IMAGE}
                """
            }
        }
    }
}
