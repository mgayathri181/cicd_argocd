pipeline {
    agent {
        docker {
            image 'gayathrimurugaian/maven-docker-agent:v8'
            args '-v /var/run/docker.sock:/var/run/docker.sock -u root'
        }
    }

    environment {
        GIT_USER_NAME = 'mgayathri181'
        GIT_REPO_NAME = 'cicd_argocd'
        SONAR_URL = "http://15.157.69.245:9000"
        SONAR_TOKEN = credentials('sonar-token')
        DOCKER_IMAGE = "gayathrimurugaian/ultimate-cicd:${BUILD_NUMBER}"
    }

    stages {
        stage('Checkout') {
            steps {
                git url: 'https://github.com/mgayathri181/cicd_argocd.git', branch: 'master'
            }
        }

        stage('Build') {
            steps {
                sh 'mvn clean install'
            }
        }

        stage('SonarQube Analysis') {
            steps {
                withSonarQubeEnv('SonarQube') {
                    sh "mvn sonar:sonar -Dsonar.projectKey=${GIT_REPO_NAME} -Dsonar.host.url=${SONAR_URL} -Dsonar.login=${SONAR_TOKEN}"
                }
            }
        }

        stage('Docker Build & Push') {
            steps {
                sh """
                    docker build -t ${DOCKER_IMAGE} .
                    echo "${DOCKER_PASSWORD}" | docker login -u "${DOCKER_USERNAME}" --password-stdin
                    docker push ${DOCKER_IMAGE}
                """
            }
        }
    }
}
